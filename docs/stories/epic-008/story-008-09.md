# Story 008-09: Layer system implementation

**Epic:** EPIC-008 - User Interface and Cross-Platform Foundation
**Status:** Not Started
**Estimate:** 5 points
**Assigned To:** Unassigned

---

## Description

As a developer, I need to implement layer system for organizing objects
so that users can manage visibility and grouping.

---

## Acceptance Criteria

- [ ] Implement Layer class (name, color, visible, locked, zOrder)
- [ ] Implement LayerManager class (CRUD operations)
- [ ] Objects are assigned to layers
- [ ] Layer visibility affects object rendering
- [ ] Layer lock prevents selection and editing
- [ ] Layer z-order affects drawing order
- [ ] Layers are saved/loaded with project

---

## Technical Notes

**Implementation Details:**
- Implement Layer class
- Implement LayerManager class
- Add layer assignment to geometry objects
- Implement visibility/lock logic in rendering
- Integrate with scene graph (QGraphicsItem)

**Layer Class:**
```cpp
class Layer {
public:
    Layer(const QString& id, const QString& name);

    // Getters
    QString id() const;
    QString name() const;
    QColor color() const;
    bool isVisible() const;
    bool isLocked() const;
    int zOrder() const;
    QList<GeometryObject*> objects() const;
    int objectCount() const;

    // Setters
    void setName(const QString& name);
    void setColor(const QColor& color);
    void setVisible(bool visible);
    void setLocked(bool locked);
    void setZOrder(int order);

    // Object management
    void addObject(GeometryObject* obj);
    void removeObject(GeometryObject* obj);
    void clear();

    // Serialization
    QJsonObject toJson() const;
    static Layer* fromJson(const QJsonObject& json);

signals:
    void visibilityChanged(bool visible);
    void lockedChanged(bool locked);
    void nameChanged(const QString& name);
    void colorChanged(const QColor& color);
    void objectAdded(GeometryObject* obj);
    void objectRemoved(GeometryObject* obj);

private:
    QString id_;
    QString name_;
    QColor color_;
    bool visible_;
    bool locked_;
    int zOrder_;
    QList<GeometryObject*> objects_;
};
```

**Layer Manager:**
```cpp
class LayerManager {
public:
    LayerManager();

    // Layer CRUD
    Layer* createLayer(const QString& name);
    void deleteLayer(const QString& layerId);
    void renameLayer(const QString& layerId, const QString& newName);
    Layer* getLayer(const QString& layerId);
    Layer* getLayerByName(const QString& name);
    QList<Layer*> getAllLayers() const;

    // Active layer
    Layer* getActiveLayer() const;
    void setActiveLayer(const QString& layerId);

    // Layer ordering
    void moveLayerUp(const QString& layerId);
    void moveLayerDown(const QString& layerId);
    void setLayerOrder(const QString& layerId, int order);

    // Default layer
    Layer* getDefaultLayer() const;

    // Utility
    void mergeLayersDown(const QString& layerId);
    Layer* duplicateLayer(const QString& layerId);

    // Serialization
    QJsonArray toJson() const;
    void fromJson(const QJsonArray& json);

signals:
    void layerCreated(Layer* layer);
    void layerDeleted(const QString& layerId);
    void layerRenamed(const QString& layerId, const QString& newName);
    void activeLayerChanged(Layer* layer);
    void layerOrderChanged();

private:
    QMap<QString, std::unique_ptr<Layer>> layers_;
    Layer* activeLayer_;
    Layer* defaultLayer_;

    QString generateUniqueId();
    QString generateUniqueName(const QString& baseName);
    void updateZOrders();
};
```

**Geometry Object Integration:**
```cpp
class GeometryObject {
public:
    // Layer assignment
    Layer* layer() const;
    void setLayer(Layer* layer);

    // Visibility (inherited from layer)
    bool isVisible() const;

    // Locked (inherited from layer)
    bool isLocked() const;

    // Z-order (inherited from layer)
    int zOrder() const;

private:
    Layer* layer_;
};
```

**QGraphicsItem Integration:**
```cpp
class GeometryGraphicsItem : public QGraphicsItem {
public:
    // Override visibility based on layer
    bool isVisible() const override {
        if (!geometryObject_->layer()) return true;
        return geometryObject_->layer()->isVisible();
    }

    // Override interaction based on layer lock
    bool isSelectable() const {
        if (!geometryObject_->layer()) return true;
        return !geometryObject_->layer()->isLocked();
    }

    // Override z-value based on layer order
    qreal zValue() const override {
        if (!geometryObject_->layer()) return 0;
        return geometryObject_->layer()->zOrder();
    }

protected:
    // Ignore interaction if layer is locked
    void mousePressEvent(QGraphicsSceneMouseEvent* event) override {
        if (isSelectable()) {
            QGraphicsItem::mousePressEvent(event);
        } else {
            event->ignore();
        }
    }

private:
    GeometryObject* geometryObject_;
};
```

**Layer Visibility Implementation:**
```cpp
void Layer::setVisible(bool visible) {
    if (visible_ == visible) return;

    visible_ = visible;

    // Update all objects on this layer
    for (auto* obj : objects_) {
        obj->updateVisibility();
    }

    emit visibilityChanged(visible);
}
```

**Layer Lock Implementation:**
```cpp
void Layer::setLocked(bool locked) {
    if (locked_ == locked) return;

    locked_ = locked;

    // Update all objects on this layer
    for (auto* obj : objects_) {
        obj->updateInteractivity();

        // Deselect if locked
        if (locked && obj->isSelected()) {
            obj->setSelected(false);
        }
    }

    emit lockedChanged(locked);
}
```

**Layer Z-Order:**
- Z-order determines drawing order (higher = on top)
- Default layer has z-order 0
- New layers get incremental z-order
- User can reorder layers via drag-and-drop in Layers Panel
- Objects inherit z-order from their layer

**Layer Operations:**

### Create Layer
```cpp
Layer* LayerManager::createLayer(const QString& name) {
    QString uniqueName = generateUniqueName(name);
    QString id = generateUniqueId();

    auto layer = std::make_unique<Layer>(id, uniqueName);
    layer->setZOrder(layers_.size());

    Layer* layerPtr = layer.get();
    layers_[id] = std::move(layer);

    emit layerCreated(layerPtr);
    return layerPtr;
}
```

### Delete Layer
```cpp
void LayerManager::deleteLayer(const QString& layerId) {
    // Cannot delete default layer
    if (layerId == defaultLayer_->id()) {
        throw std::runtime_error("Cannot delete default layer");
    }

    Layer* layer = getLayer(layerId);
    if (!layer) return;

    // Move objects to default layer
    for (auto* obj : layer->objects()) {
        defaultLayer_->addObject(obj);
        obj->setLayer(defaultLayer_);
    }

    // If deleting active layer, switch to default
    if (activeLayer_ == layer) {
        activeLayer_ = defaultLayer_;
    }

    layers_.remove(layerId);
    emit layerDeleted(layerId);

    updateZOrders();
}
```

### Merge Layers
```cpp
void LayerManager::mergeLayersDown(const QString& layerId) {
    Layer* layer = getLayer(layerId);
    if (!layer) return;

    // Find layer below
    Layer* targetLayer = nullptr;
    int targetZOrder = layer->zOrder() - 1;
    for (auto& [id, lay] : layers_) {
        if (lay->zOrder() == targetZOrder) {
            targetLayer = lay.get();
            break;
        }
    }

    if (!targetLayer) return;

    // Move all objects to target layer
    for (auto* obj : layer->objects()) {
        targetLayer->addObject(obj);
        obj->setLayer(targetLayer);
    }

    deleteLayer(layerId);
}
```

**Default Layer:**
- Every project has a default layer (Layer 0)
- Cannot be deleted
- Objects without explicit layer assignment go to default layer
- Can be hidden but always exists

**Auto-generated Names:**
- New layers: "Layer 1", "Layer 2", etc.
- Duplicated layers: "Layer 1 Copy", "Layer 1 Copy 2", etc.
- Ensure uniqueness

**Serialization:**
```json
{
  "layers": [
    {
      "id": "layer_001",
      "name": "Layer 1",
      "color": "#ff0000",
      "visible": true,
      "locked": false,
      "zOrder": 0
    },
    {
      "id": "layer_002",
      "name": "Pattern Pieces",
      "color": "#00ff00",
      "visible": true,
      "locked": false,
      "zOrder": 1
    }
  ],
  "activeLayer": "layer_002"
}
```

---

## Dependencies

None - Core system

---

## Definition of Done

- [ ] Code implemented and committed
- [ ] Unit tests written and passing
- [ ] Integration tests passing
- [ ] Code reviewed and approved
- [ ] Documentation updated
- [ ] Manual testing completed
- [ ] No critical or high-priority bugs
- [ ] Acceptance criteria verified
- [ ] Layer visibility working correctly
- [ ] Layer lock prevents interaction
- [ ] Z-order affects rendering order
- [ ] Serialization/deserialization working
