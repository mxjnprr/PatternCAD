# Story 002-04: Propagate parameter updates to geometry

**Epic:** EPIC-002 - Parametric Design and Constraint System
**Status:** Not Started
**Estimate:** 8 points
**Assigned To:** Unassigned

---

## Description

As a pattern designer, when I change a parameter value, I want all dependent geometry to update automatically
so that my entire pattern adjusts correctly.

---

## Acceptance Criteria

- [ ] Changing parameter value triggers update propagation
- [ ] Dependent parameters recalculate in correct order (topological)
- [ ] Geometry objects referencing parameters update positions/dimensions
- [ ] Update completes in < 500ms for typical patterns (50 objects)
- [ ] Canvas re-renders to show updated geometry
- [ ] Update operation is undoable (single undo step)
- [ ] No flickering or visual artifacts during update
- [ ] Progress indicator for long updates (> 1 second)

---

## Technical Notes

**ParametricEngine Class:**
```cpp
class ParametricEngine {
    QMap<QString, Parameter*> parameters;
    DependencyGraph dependencyGraph;
    QSet<GeometryObject*> affectedGeometry;

public:
    void updateParameter(const QString& name, double newValue);
    void addParameter(Parameter* param);
    void removeParameter(const QString& name);

private:
    void propagateUpdates(const QString& changedParam);
    QList<QString> getUpdateOrder(const QString& startParam);
    void updateGeometry();
    void notifyViews();
};
```

**Update Algorithm:**
```
1. User changes parameter "waist_width" from 80 to 85
2. Build list of affected parameters (topological sort from waist_width)
3. For each affected parameter in order:
   a. Evaluate expression
   b. Update parameter value
   c. Mark dependent geometry as dirty
4. For each dirty geometry object:
   a. Call updateFromParameters()
   b. Recalculate positions/dimensions
5. Trigger constraint solver if needed
6. Notify views to re-render
7. Create UpdateParameterCommand for undo
```

**Observer Pattern:**
```cpp
class GeometryObject {
    QSet<Parameter*> usedParameters;

    virtual void updateFromParameters() = 0;
};

// Example: Line using parameters
class Line : public GeometryObject {
    void updateFromParameters() override {
        if (lengthParam) {
            double newLength = lengthParam->value;
            // Adjust end point to maintain length
            end = calculateEndPoint(start, angle, newLength);
        }
    }
};
```

**Performance Optimization:**
- Batch geometry updates (don't re-render after each)
- Use dirty flags to avoid unnecessary recalculation
- Only update visible objects if isolation mode active

---

## Dependencies

- story-002-01: Parameters
- story-002-02: Expression parser
- story-002-03: Dependency graph
- story-008-08: Undo system

---

## Definition of Done

- [ ] ParametricEngine implemented
- [ ] Update propagation working correctly
- [ ] Geometry updates automatically
- [ ] Performance target met (< 500ms for 50 objects)
- [ ] Undo/redo working
- [ ] Unit tests for engine
- [ ] Integration tests with geometry
- [ ] Documentation updated
- [ ] Merged to main branch
