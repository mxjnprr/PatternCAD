# Story 002-09: Integrate constraint solver with geometry editing

**Epic:** EPIC-002 - Parametric Design and Constraint System
**Status:** Not Started
**Estimate:** 8 points
**Assigned To:** Unassigned

---

## Description

As a pattern designer, when I move constrained objects, I want the solver to automatically adjust geometry
so that all constraints remain satisfied.

---

## Acceptance Criteria

- [ ] Moving constrained objects triggers solver automatically
- [ ] Solver runs in < 200ms (user doesn't notice delay)
- [ ] Geometry adjusts smoothly to maintain constraints
- [ ] If solver fails to converge, show warning and keep original positions
- [ ] Solver operations are undoable (integrated with undo system)
- [ ] Solver doesn't interfere with normal (unconstrained) editing
- [ ] Visual feedback during solving (optional progress indicator for slow solves)
- [ ] User can temporarily disable solver (hold Ctrl while moving)

---

## Technical Notes

**Integration Points:**
```cpp
// In MoveObjectsCommand
void MoveObjectsCommand::execute() {
    // Move objects to new positions
    for (auto* obj : objects) {
        obj->setPosition(newPositions[obj]);
    }

    // Check if any objects have constraints
    if (hasConstraints(objects)) {
        // Run constraint solver
        ConstraintSolver solver;
        solver.setConstraints(getRelevantConstraints(objects));

        auto result = solver.solve();

        if (result != ConstraintSolver::Converged) {
            // Solver failed - show warning
            showSolverWarning(result);
            // Optionally: revert to original positions
        }
    }

    // Update canvas
    emit geometryChanged();
}
```

**Performance Considerations:**
- Only solve constraints involving moved objects (don't solve entire system)
- Cache solver state between operations
- Run solver asynchronously for complex systems (> 50 constraints)
- Show progress indicator if solving takes > 500ms

**User Feedback:**
- Status bar message: "Solving constraints..." (if > 100ms)
- Progress indicator for long solves
- Warning dialog if solver fails:
  ```
  "Constraint Solver Warning"
  "Unable to satisfy all constraints.
   The geometry may not meet all requirements."
  [View Constraints] [OK]
  ```

**Temporary Disable:**
- Hold Ctrl while dragging to bypass solver
- Useful for making large adjustments before solver kicks in

**Undo Integration:**
```cpp
void MoveObjectsCommand::undo() {
    // Restore original positions (before solve)
    for (auto* obj : objects) {
        obj->setPosition(originalPositions[obj]);
    }

    // Re-run solver (will return to original solution)
    // Or: cache solved state and restore it

    emit geometryChanged();
}
```

---

## Dependencies

- story-002-08: Constraint solver implementation
- story-008-08: Undo/redo system
- story-001-06: Move command

---

## Definition of Done

- [ ] Solver integrated with move operations
- [ ] Automatic solving working
- [ ] Performance target met (< 200ms)
- [ ] Failure handling implemented
- [ ] Undo/redo working with solver
- [ ] Temporary disable (Ctrl) working
- [ ] User feedback implemented
- [ ] Integration tests with UI
- [ ] Documentation updated
- [ ] Merged to main branch
