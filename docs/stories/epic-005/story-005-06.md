# Story 005-06: Calculate and display material utilization

**Epic:** EPIC-005 - Layout, Nesting, and Isolation
**Status:** Not Started
**Estimate:** 3 points
**Assigned To:** Unassigned

---

## Description

As a pattern designer, I want to see material utilization percentage and waste area
so that I can assess efficiency of my layout.

---

## Acceptance Criteria

- [ ] System calculates total area of all placed pieces
- [ ] System calculates layout sheet area
- [ ] System displays utilization percentage: (pieces area / sheet area) × 100%
- [ ] System displays total used area and waste area
- [ ] Metrics update in real-time as pieces are moved
- [ ] Metrics are displayed in layout status panel or status bar

---

## Technical Notes

**Utilization Calculator:**
```cpp
class UtilizationCalculator {
    LayoutSheet* sheet;

    struct UtilizationMetrics {
        double totalSheetArea;
        double totalPiecesArea;
        double wasteArea;
        double utilizationPercentage;
    };

    UtilizationMetrics calculate() {
        UtilizationMetrics metrics;

        // Calculate sheet area
        metrics.totalSheetArea = sheet->width() * sheet->height();

        // Calculate sum of all pattern areas on sheet
        metrics.totalPiecesArea = 0.0;
        for (Pattern* pattern : sheet->getPlacedPatterns()) {
            metrics.totalPiecesArea += pattern->area();
        }

        // Calculate waste
        metrics.wasteArea = metrics.totalSheetArea - metrics.totalPiecesArea;

        // Calculate utilization percentage
        if (metrics.totalSheetArea > 0) {
            metrics.utilizationPercentage =
                (metrics.totalPiecesArea / metrics.totalSheetArea) * 100.0;
        } else {
            metrics.utilizationPercentage = 0.0;
        }

        return metrics;
    }
};
```

**Real-Time Updates:**
```cpp
class LayoutSheet : public QObject {
    UtilizationCalculator calculator;

    void onPatternMoved(Pattern* pattern) {
        // Recalculate utilization
        auto metrics = calculator.calculate();
        emit utilizationChanged(metrics);
    }

    void onPatternAdded(Pattern* pattern) {
        connect(pattern, &Pattern::transformChanged,
                this, &LayoutSheet::onPatternMoved);

        auto metrics = calculator.calculate();
        emit utilizationChanged(metrics);
    }

    void onPatternRemoved(Pattern* pattern) {
        disconnect(pattern, &Pattern::transformChanged,
                  this, &LayoutSheet::onPatternMoved);

        auto metrics = calculator.calculate();
        emit utilizationChanged(metrics);
    }
};
```

**UI Display:**
```
Status Bar (bottom right):
┌────────────────────────────────────┐
│ Utilization: 78.5% | Used: 2.4 m² │
│ Waste: 0.65 m²                     │
└────────────────────────────────────┘

Or Layout Panel:
┌─ Material Utilization ─────────┐
│ Sheet: 1500mm × 1000mm         │
│ Total area: 1.50 m²            │
│                                 │
│ Used:   1.18 m² (78.5%)        │
│ Waste:  0.32 m² (21.5%)        │
│                                 │
│ [■■■■■■■■□□] 78.5%             │
└─────────────────────────────────┘
```

**Performance:**
- Avoid recalculating during continuous drag operations
- Debounce calculations (update every 100ms during drag)
- Cache pattern areas (recalculate only when pattern geometry changes)

---

## Dependencies

- story-005-01: Layout sheets

---

## Definition of Done

- [ ] UtilizationCalculator implemented
- [ ] Area calculations working accurately
- [ ] Utilization percentage calculation correct
- [ ] Real-time updates working
- [ ] UI display implemented (status bar or panel)
- [ ] Performance optimization (debouncing)
- [ ] Unit tests for calculations
- [ ] Integration tests
- [ ] Documentation updated
- [ ] Merged to main branch
