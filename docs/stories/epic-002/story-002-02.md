# Story 002-02: Define parameter expressions with formula parser

**Epic:** EPIC-002 - Parametric Design and Constraint System
**Status:** Not Started
**Estimate:** 8 points
**Assigned To:** Unassigned

---

## Description

As a pattern designer, I want to define parameters using mathematical expressions
so that parameters can be calculated from other parameters.

---

## Acceptance Criteria

- [ ] User can enter expression like "waist_width / 2 + seam_allowance"
- [ ] Expression parser supports operators: +, -, *, /, ^, ()
- [ ] Expression parser supports functions: sin, cos, tan, sqrt, abs, min, max
- [ ] Expression can reference other parameters by name
- [ ] Invalid expressions show clear error messages with position
- [ ] Expression evaluation respects order of operations (PEMDAS)
- [ ] Expression updates automatically when referenced parameters change
- [ ] Division by zero handled gracefully with error message

---

## Technical Notes

**Parser Implementation Options:**
1. Use existing library (muparser - MIT license)
2. Implement custom recursive descent parser

**Grammar (EBNF):**
```
expression  ::= term (('+' | '-') term)*
term        ::= factor (('*' | '/') factor)*
factor      ::= base ('^' exponent)?
base        ::= number | identifier | function_call | '(' expression ')'
function    ::= ('sin' | 'cos' | 'sqrt' | ...) '(' expression ')'
```

**ExpressionParser Class:**
```cpp
class ExpressionParser {
public:
    double evaluate(const QString& expression,
                   const QMap<QString, double>& variables);
    bool validate(const QString& expression, QString& error);
    QSet<QString> extractVariables(const QString& expression);

private:
    Token nextToken();
    double parseExpression();
    double parseTerm();
    double parseFactor();
};
```

**Supported Functions:**
- Trigonometric: sin, cos, tan, asin, acos, atan
- Math: sqrt, abs, pow, exp, log, log10
- Utility: min, max, round, ceil, floor

**Error Messages:**
- "Syntax error at position 15: expected ')'"
- "Unknown variable 'widht' (did you mean 'width'?)"
- "Division by zero in expression"
- "Circular dependency detected"

---

## Dependencies

- story-002-01: Parameter management must exist

---

## Definition of Done

- [ ] Expression parser implemented
- [ ] All operators and functions working
- [ ] Clear error messages with position
- [ ] Unit tests for parser (edge cases)
- [ ] Performance: < 1ms for typical expression
- [ ] Documentation with examples
- [ ] Merged to main branch
