# Story 008-11: Cross-platform build and packaging

**Epic:** EPIC-008 - User Interface and Cross-Platform Foundation
**Status:** Not Started

## Implementation Status

**BUILD SYSTEM STATUS - NOT VERIFIED IN THIS ANALYSIS**
This is an infrastructure story requiring CI/CD pipeline verification. Code analysis alone cannot determine build/packaging status. Manual verification required.
**Estimate:** 13 points
**Assigned To:** Unassigned

---

## Description

As a developer, I need build system and packaging for Linux and Windows
so that users can install and run PatternCAD on both platforms.

---

## Acceptance Criteria

- [ ] CMake build system configured for Qt project
- [ ] Project builds on Linux (Ubuntu 20.04+, Fedora, Manjaro)
- [ ] Project builds on Windows (Windows 10/11)
- [ ] Linux packaging: AppImage, .deb, .rpm
- [ ] Windows packaging: NSIS installer, portable .zip
- [ ] Build includes all dependencies (Qt, libraries)
- [ ] CI/CD pipeline builds for both platforms
- [ ] Installation creates file associations (.patterncad)

---

## Technical Notes

**Implementation Details:**
- Create CMakeLists.txt
- Set up vcpkg or Conan for dependencies
- Configure linuxdeploy for AppImage
- Create .deb and .rpm packaging scripts
- Create NSIS installer script for Windows
- Set up GitHub Actions or GitLab CI
- Test builds on target platforms

**CMake Build System:**

### Root CMakeLists.txt
```cmake
cmake_minimum_required(VERSION 3.16)
project(PatternCAD VERSION 0.1.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTORCC ON)
set(CMAKE_AUTOUIC ON)

# Find Qt6
find_package(Qt6 REQUIRED COMPONENTS
    Core
    Widgets
    Gui
    Svg
    PrintSupport
)

# Find other dependencies
find_package(Eigen3 REQUIRED)

# Source files
add_subdirectory(src)

# Resources
qt_add_resources(RESOURCES resources/resources.qrc)

# Executable
add_executable(patterncad
    ${SOURCES}
    ${RESOURCES}
)

target_link_libraries(patterncad PRIVATE
    Qt6::Core
    Qt6::Widgets
    Qt6::Gui
    Qt6::Svg
    Qt6::PrintSupport
    Eigen3::Eigen
)

# Install rules
include(GNUInstallDirs)

install(TARGETS patterncad
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
)

install(FILES resources/patterncad.desktop
    DESTINATION ${CMAKE_INSTALL_DATADIR}/applications
)

install(FILES resources/icons/patterncad.png
    DESTINATION ${CMAKE_INSTALL_DATADIR}/icons/hicolor/256x256/apps
)

# Packaging
include(cmake/Packaging.cmake)
```

### src/CMakeLists.txt
```cmake
set(SOURCES
    main.cpp
    mainwindow.cpp
    mainwindow.h
    canvas/patterncanvas.cpp
    canvas/patterncanvas.h
    canvas/patternscene.cpp
    canvas/patternscene.h
    # ... more source files
)

add_library(patterncad_lib STATIC ${SOURCES})

target_link_libraries(patterncad_lib PUBLIC
    Qt6::Core
    Qt6::Widgets
    Qt6::Gui
    Qt6::Svg
)

target_include_directories(patterncad_lib PUBLIC
    ${CMAKE_CURRENT_SOURCE_DIR}
)
```

**Dependency Management with vcpkg:**

### vcpkg.json
```json
{
  "name": "patterncad",
  "version": "0.1.0",
  "dependencies": [
    "qt6-base",
    "qt6-svg",
    "eigen3",
    "libdxfrw"
  ]
}
```

### CMake Toolchain
```bash
cmake -B build -S . \
  -DCMAKE_TOOLCHAIN_FILE=/path/to/vcpkg/scripts/buildsystems/vcpkg.cmake
```

**Linux Packaging:**

### AppImage
```bash
# install linuxdeploy
wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
chmod +x linuxdeploy*.AppImage

# Build AppImage
./linuxdeploy-x86_64.AppImage \
  --executable=build/patterncad \
  --appdir=AppDir \
  --plugin qt \
  --desktop-file=resources/patterncad.desktop \
  --icon-file=resources/icons/patterncad.png \
  --output appimage
```

### Debian Package (.deb)
```cmake
# In cmake/Packaging.cmake
set(CPACK_GENERATOR "DEB")
set(CPACK_DEBIAN_PACKAGE_MAINTAINER "PatternCAD Team")
set(CPACK_DEBIAN_PACKAGE_DEPENDS "libqt6core6, libqt6widgets6, libqt6gui6, libqt6svg6")
set(CPACK_DEBIAN_PACKAGE_SECTION "graphics")
set(CPACK_DEBIAN_PACKAGE_DESCRIPTION "Professional pattern design CAD software")

include(CPack)
```

Build:
```bash
cmake --build build --target package
```

### RPM Package
```cmake
set(CPACK_GENERATOR "RPM")
set(CPACK_RPM_PACKAGE_LICENSE "MIT")
set(CPACK_RPM_PACKAGE_GROUP "Applications/Graphics")
set(CPACK_RPM_PACKAGE_REQUIRES "qt6-qtbase, qt6-qtsvg")
```

**Windows Packaging:**

### NSIS Installer Script
```nsi
; patterncad-installer.nsi
!include "MUI2.nsh"

Name "PatternCAD"
OutFile "PatternCAD-Setup-0.1.0.exe"
InstallDir "$PROGRAMFILES64\PatternCAD"
RequestExecutionLevel admin

!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE "LICENSE.txt"
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

!insertmacro MUI_LANGUAGE "English"

Section "PatternCAD" SecMain
    SetOutPath "$INSTDIR"

    ; Copy executable and DLLs
    File "build\Release\patterncad.exe"
    File /r "deploy\*.*"

    ; Create shortcuts
    CreateDirectory "$SMPROGRAMS\PatternCAD"
    CreateShortcut "$SMPROGRAMS\PatternCAD\PatternCAD.lnk" "$INSTDIR\patterncad.exe"
    CreateShortcut "$DESKTOP\PatternCAD.lnk" "$INSTDIR\patterncad.exe"

    ; Write uninstaller
    WriteUninstaller "$INSTDIR\Uninstall.exe"

    ; Register file association
    WriteRegStr HKCR ".patterncad" "" "PatternCAD.Document"
    WriteRegStr HKCR "PatternCAD.Document" "" "PatternCAD Document"
    WriteRegStr HKCR "PatternCAD.Document\DefaultIcon" "" "$INSTDIR\patterncad.exe,0"
    WriteRegStr HKCR "PatternCAD.Document\shell\open\command" "" '"$INSTDIR\patterncad.exe" "%1"'

    ; Add to Programs and Features
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PatternCAD" \
                     "DisplayName" "PatternCAD"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PatternCAD" \
                     "UninstallString" "$INSTDIR\Uninstall.exe"
SectionEnd

Section "Uninstall"
    ; Remove files
    Delete "$INSTDIR\*.*"
    RMDir /r "$INSTDIR"

    ; Remove shortcuts
    Delete "$SMPROGRAMS\PatternCAD\PatternCAD.lnk"
    RMDir "$SMPROGRAMS\PatternCAD"
    Delete "$DESKTOP\PatternCAD.lnk"

    ; Remove file association
    DeleteRegKey HKCR ".patterncad"
    DeleteRegKey HKCR "PatternCAD.Document"

    ; Remove from Programs and Features
    DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PatternCAD"
SectionEnd
```

### Windows Deploy Script
```powershell
# deploy-windows.ps1
$QT_PATH = "C:\Qt\6.5.0\msvc2019_64"
$BUILD_DIR = "build\Release"
$DEPLOY_DIR = "deploy"

# Run windeployqt
& "$QT_PATH\bin\windeployqt.exe" `
    --release `
    --no-translations `
    --dir $DEPLOY_DIR `
    "$BUILD_DIR\patterncad.exe"

# Copy additional DLLs
Copy-Item "$BUILD_DIR\patterncad.exe" -Destination $DEPLOY_DIR

# Create NSIS installer
& "C:\Program Files (x86)\NSIS\makensis.exe" patterncad-installer.nsi
```

### Portable ZIP
```bash
# Create portable package
mkdir -p patterncad-portable
cp -r deploy/* patterncad-portable/
zip -r PatternCAD-0.1.0-portable.zip patterncad-portable/
```

**CI/CD Pipeline:**

### GitHub Actions
```yaml
# .github/workflows/build.yml
name: Build PatternCAD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.0'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libeigen3-dev

      - name: Build
        run: |
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build

      - name: Test
        run: |
          cd build
          ctest --output-on-failure

      - name: Package AppImage
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage
          ./linuxdeploy-x86_64.AppImage --executable=build/patterncad --appdir=AppDir --plugin qt --output appimage

      - name: Upload AppImage
        uses: actions/upload-artifact@v3
        with:
          name: PatternCAD-Linux-AppImage
          path: PatternCAD-*.AppImage

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.0'
          arch: 'win64_msvc2019_64'

      - name: Build
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64
          cmake --build build --config Release

      - name: Deploy
        run: |
          windeployqt --release --no-translations build\Release\patterncad.exe

      - name: Create Installer
        run: |
          makensis patterncad-installer.nsi

      - name: Upload Installer
        uses: actions/upload-artifact@v3
        with:
          name: PatternCAD-Windows-Installer
          path: PatternCAD-Setup-*.exe
```

**File Associations:**

### Linux Desktop Entry
```desktop
[Desktop Entry]
Type=Application
Name=PatternCAD
Comment=Professional pattern design CAD software
Exec=patterncad %F
Icon=patterncad
Terminal=false
Categories=Graphics;VectorGraphics;Engineering;
MimeType=application/x-patterncad;
```

### MIME Type Registration
```xml
<?xml version="1.0" encoding="UTF-8"?>
<mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info">
    <mime-type type="application/x-patterncad">
        <comment>PatternCAD Document</comment>
        <glob pattern="*.patterncad"/>
        <icon name="patterncad"/>
    </mime-type>
</mime-info>
```

**Platform-Specific Testing:**
- Ubuntu 20.04, 22.04
- Fedora 38, 39
- Manjaro (Arch-based)
- Windows 10 (version 21H1+)
- Windows 11

**Build Verification:**
- Executable runs on target platforms
- All dependencies bundled
- File associations work
- Uninstaller works (Windows)
- AppImage portable (no installation required)

---

## Dependencies

None - Infrastructure story

---

## Definition of Done

- [ ] Code implemented and committed
- [ ] CMakeLists.txt complete and tested
- [ ] Builds successfully on Ubuntu 20.04+
- [ ] Builds successfully on Windows 10/11
- [ ] AppImage created and tested
- [ ] .deb package created and tested
- [ ] .rpm package created and tested
- [ ] Windows installer created and tested
- [ ] CI/CD pipeline functional
- [ ] File associations working on all platforms
- [ ] Documentation updated with build instructions
- [ ] Manual testing completed on all target platforms
